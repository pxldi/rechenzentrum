---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openclaw
  namespace: openclaw
spec:
  interval: 30m
  chart:
    spec:
      chart: openclaw
      version: "1.3.7"
      sourceRef:
        kind: HelmRepository
        name: openclaw
        namespace: openclaw
      interval: 12h
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    app-template:
      configMode: merge

      networkpolicies:
        main:
          enabled: true
          controller: main
          policyTypes:
            - Ingress
            - Egress
          rules:
            ingress:
              - from:
                  - namespaceSelector:
                      matchLabels:
                        kubernetes.io/metadata.name: traefik
                ports:
                  - protocol: TCP
                    port: 18789
            egress:
              # DNS
              - to:
                  - namespaceSelector:
                      matchLabels:
                        kubernetes.io/metadata.name: kube-system
                    podSelector:
                      matchLabels:
                        k8s-app: kube-dns
                ports:
                  - protocol: UDP
                    port: 53
                  - protocol: TCP
                    port: 53
              # SearXNG
              - to:
                  - namespaceSelector:
                      matchLabels:
                        kubernetes.io/metadata.name: searxng
                ports:
                  - protocol: TCP
                    port: 8080
              # External internet (blocks private ranges)
              - to:
                  - ipBlock:
                      cidr: 0.0.0.0/0
                      except:
                        - 10.0.0.0/8
                        - 172.16.0.0/12
                        - 192.168.0.0/16
                        - 169.254.0.0/16
                        - 100.64.0.0/10

      controllers:
        main:
          containers:
            main:
              envFrom:
                - secretRef:
                    name: openclaw-credentials

      configMaps:
        config:
          enabled: true
          data:
            openclaw.json: |
              {
                "gateway": {
                  "port": 18789,
                  "mode": "local"
                },
                "browser": {
                  "enabled": true,
                  "defaultProfile": "openclaw",
                  "profiles": {
                    "openclaw": {
                      "cdpUrl": "http://localhost:9222",
                      "color": "#4A90D9"
                    }
                  }
                },
                "agents": {
                  "defaults": {
                    "model": {
                      "primary": "zai/glm-4.7"
                    },
                    "thinkingDefault": "low",
                    "timeoutSeconds": 600,
                    "models": {
                      "zai/glm-4.7": {
                        "alias": "GLM"
                      }
                    }
                  }
                },
                "tools": {
                  "web": {
                    "search": {
                      "enabled": true
                    },
                    "fetch": {
                      "enabled": true
                    }
                  }
                },
                "skills": {
                  "install": {
                    "nodeManager": "npm"
                  },
                  "entries": {
                    "web-search-plus": {
                      "enabled": true,
                      "env": {
                        "SEARXNG_INSTANCE_URL": "http://searxng.searxng.svc.cluster.local:8080"
                      }
                    }
                  }
                }
              }