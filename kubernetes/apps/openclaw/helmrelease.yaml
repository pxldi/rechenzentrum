---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openclaw
  namespace: openclaw
spec:
  interval: 30m
  chart:
    spec:
      chart: openclaw
      version: '*'  # Use latest version
      sourceRef:
        kind: HelmRepository
        name: openclaw
        namespace: openclaw
      interval: 12h
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    env:
      - name: HOME
        value: /tmp
      - name: npm_config_cache
        value: /tmp/.npm

    openclaw:
      agents:
        defaults:
          model: "zai/glm-4.7"
          thinkingDefault: "low"
          timeoutSeconds: 600
      
      # Skills to install
      skills:
        - web-search-plus
      
      # Advanced config merged into openclaw.json
      configOverrides:
        agents:
          defaults:
            models:
              "zai/glm-4.7":
                alias: "GLM"
        tools:
          web:
            search:
              enabled: true
            fetch:
              enabled: true
        skills:
          install:
            nodeManager: "npm"
          entries:
            web-search-plus:
              enabled: true
              env:
                SEARXNG_INSTANCE_URL: "http://searxng.searxng.svc.cluster.local:8080"

    credentials:
      existingSecret: openclaw-credentials

    persistence:
      enabled: true
      storageClass: local-ssd
      size: 10Gi
      accessMode: ReadWriteOnce

    resources:
      requests:
        memory: 512Mi
        cpu: 250m
      limits:
        memory: 2Gi
        cpu: 1000m

    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      fsGroup: 1000