---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openclaw
  namespace: openclaw
spec:
  interval: 30m
  chart:
    spec:
      chart: openclaw
      version: '1.3.7'
      sourceRef:
        kind: HelmRepository
        name: openclaw
        namespace: openclaw
      interval: 12h
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    configMode: merge
    
    # OpenClaw configuration
    openclaw:
      agents:
        defaults:
          model: "zai/glm-4.7"
          thinkingDefault: "low"
          timeoutSeconds: 600
          models:
            "zai/glm-4.7":
              alias: "GLM"
      
      browser:
        enabled: true
        headless: true
        noSandbox: true
        defaultProfile: "openclaw"
        profiles:
          openclaw:
            cdpPort: 9222
            color: '#4A90D9'
      
      tools:
        web:
          search:
            enabled: true
          fetch:
            enabled: true
      
      skills:
        install:
          nodeManager: "npm"
        entries:
          web-search-plus:
            enabled: true
            env:
              SEARXNG_INSTANCE_URL: "http://searxng.searxng.svc.cluster.local:8080"
    
    app-template:
      controllers:
        main:
          containers:
            main:
              env:
                HOME: /tmp
                npm_config_cache: /tmp/.npm
              envFrom:
                - secretRef:
                    name: openclaw-credentials
      
      persistence:
        data:
          enabled: true
          existingClaim: "openclaw"
      
      service:
        main:
          ports:
            http:
              port: 18789
      
      resources:
        requests:
          memory: 512Mi
          cpu: 250m
        limits:
          memory: 2Gi
          cpu: 1000m
      
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000